# Criar imagem de disco (nfdos.img)
export NEORICALEX_ROOT=$(pwd)

export NFDOS_ROOT=$NEORICALEX_ROOT/desktop/0.1
export NFDOS_ROOTFS=$NFDOS_ROOT/rootfs
export NFDOS_DISCO=$NFDOS_ROOT/nfdos.img
export NFDOS_DEV=$NEORICALEX_ROOT/testes/nfdos

echo "Checkando se a $NFDOS_ROOT existe"
if [ ! -d "$NFDOS_ROOT" ]; then
    sudo mkdir $NFDOS_ROOT
else
    echo "A $NFDOS_ROOT existe"
fi

echo "Checkando se a $NFDOS_DISCO existe"
if [ ! -f "$NFDOS_DISCO" ]; then
    echo "Criando a $NFDOS_DISCO. Aguarde por favor..."
    sudo dd if=/dev/zero of=$NFDOS_DISCO bs=8M count=1024
    echo "Formatando a $NFDOS_DISCO"
    sudo mkfs -t ext4 $NFDOS_DISCO
else
    echo "A $NFDOS_DISCO existe"
fi

echo "Checkando se a $NFDOS_ROOTFS existe"
if [ ! -d "$NFDOS_ROOTFS" ]; then
    echo "Criando a $NFDOS_ROOTFS..."
    sudo mkdir $NFDOS_ROOTFS
else
    echo "A $NFDOS_ROOTFS existe"
fi

echo "Checkando se a $NFDOS_ROOTFS está montada"
if grep -qs "$NFDOS_ROOTFS" /proc/mounts; then
    echo "A $NFDOS_ROOTFS está montada."
else
    sudo mount -t auto -o loop $NFDOS_DISCO $NFDOS_ROOTFS
fi

echo "Checkando se o ROOTFS existe"
if [ ! -d "$NFDOS_ROOTFS/root" ]; then
    echo "Criando o ROOTFS"
    sudo debootstrap --arch=amd64 --variant=minbase focal $NFDOS_ROOTFS
else
    echo "O ROOTFS existe"
fi

echo "Montar a /dev e /run"
sudo mount --bind /dev $NFDOS_ROOTFS/dev
sudo mount --bind /run $NFDOS_ROOTFS/run

echo "Copiar a rootfs.nfdos para o $NFDOS_ROOTFS"
sudo cp $NFDOS_ROOT/rootfs.nfdos $NFDOS_ROOTFS/.

echo "Entrar no $NFDOS_ROOTFS e executar o rootfs.nfdos"
sudo chroot $NFDOS_ROOTFS /bin/bash rootfs.nfdos

echo "OK. Neste ponto a nossa imagem de disco (nfdos.img) está criada."
echo "Agora vamos criar uma imagem de CD/DVD para que possamos rodar ela em qualquer Computador/VPS/VM/Etc"
echo "Antes porém, vamos remover o rootfs.nfdos do $NFDOS_ROOTFS pois não é mais necessário..."
echo "# INFO: Vai aparecer vários \"Unrecognised xattr prefix system.posix_acl_access\" mas não é nada de preocupante :-)"
sudo rm $NFDOS_ROOTFS/rootfs.nfdos

echo "Criar imagem de CD/DVD (nfdos.iso)"
cd $NFDOS_ROOT
sudo chmod +x cdrom.nfdos
sudo bash cdrom.nfdos

echo "Desmontar a /dev e /run"
sudo umount -lf $NFDOS_ROOTFS/dev
sudo umount -lf $NFDOS_ROOTFS/run

echo "Desmontar o $NFDOS_ROOTFS"
sudo umount -lf $NFDOS_ROOTFS
